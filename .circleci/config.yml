version: 2.1

jobs:
  cypress_tests_cli:
    parallelism: 5
    docker:
      - image: cypress/browsers:latest
    working_directory: ~/app
    steps:
      - checkout
      - restore_cache:
          key: v5-deps-{{ checksum "package-lock.json" }}
      - run: npm install
      - save_cache:
          key: v5-deps-{{ checksum "package-lock.json" }}
          paths:
            - ~/.cache
      - run:
          name: Build
          command: npm run build
      - run:
          name: Cypress Tests with @currents/cli
          environment:
            COMMIT_INFO_MESSAGE: "[@currents/cli] $(git log -1 --pretty=%B)"
          command: |
            cd examples/webapp
            npm install @currents/cli
            npx currents run --record --parallel \
            --spec "./cypress/e2e*/*.spec.js" \
            --tag "currents-cli,circleCI" \
            --browser chrome --key $CURRENTS_RECORD_KEY

  cypress_tests_cloud:
    parallelism: 5
    docker:
      - image: cypress/browsers:latest
    working_directory: ~/app
    steps:
      - checkout
      - restore_cache:
          key: v5-deps-{{ checksum "package-lock.json" }}
      - run: npm install
      - save_cache:
          key: v5-deps-{{ checksum "package-lock.json" }}
          paths:
            - ~/.cache
      - run:
          name: Build
          command: npm run build
      - run:
          name: Cypress Tests with cypress-cloud
          environment:
            COMMIT_INFO_MESSAGE: "[cypress-cloud] $(git log -1 --pretty=%B)"
          command: |
            cd examples/webapp
            node ../../packages/cypress-cloud/out/bin/index.js run --record --parallel \
            --spec "./cypress/e2e*/*.spec.js" \
            --tag "cypress-cloud,circleCI" \
            --browser chrome --key $CURRENTS_RECORD_KEY

workflows:
  cypress:
    jobs:
      - cypress_tests_cli:
          context: currents
      - cypress_tests_cloud:
          context: currents
